name: Deploy Forgejo New-updateds


on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Vault CLI
      run: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
        sudo apt update && sudo apt install vault jq -y

    - name: Authenticate to Vault (userpass)
      run: |
        export VAULT_ADDR=${{ secrets.VAULT_ADDR }}
        vault login -method=userpass \
          username=${{ secrets.VAULT_USERNAME }} \
          password=${{ secrets.VAULT_PASSWORD }} \
          -format=json > vault_auth.json
        export VAULT_TOKEN=$(jq -r .auth.client_token vault_auth.json)
        echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

    - name: Fetch Forgejo Secrets
      run: |
        export VAULT_ADDR=${{ secrets.VAULT_ADDR }}
        export VAULT_TOKEN=${{ secrets.VAULT_TOKEN }}
        vault kv get -format=json secret/FORGEJO > forgejo_secrets.json
        cat forgejo_secrets.json | jq -r '.data.data | to_entries[] | "\(.key)=\(.value)"' >> .env

    - name: Deploy Forgejo with Docker Compose
      run: |
        docker compose --env-file .env up -d --build
